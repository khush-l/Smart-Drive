This file is a merged representation of a subset of the codebase, containing files not matching ignore patterns, combined into a single document by Repomix.
The content has been processed where content has been compressed (code blocks are separated by â‹®---- delimiter).

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching these patterns are excluded: data.csv, output_files/**
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Content has been compressed - code blocks are separated by â‹®---- delimiter
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

<additional_info>

</additional_info>

</file_summary>

<directory_structure>
.github/
  workflows/
    python-test.yml
static/
  index.css
  script.js
templates/
  index.html
tests/
  __init__.py
  test_route_safety.py
  test_routes.py
topic_prompts/
  initial_prompt.txt
  voice_route_demo_prompt.txt
--output
.gitignore
app.py
README.md
requirements-test.txt
requirements.txt
Route_Safety.py
testing.ipynb
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="--output">
ğŸ“¦ Repomix v0.3.1

No custom config found at repomix.config.json or global config at /home/codespace/.config/repomix/repomix.config.json.
You can add a config file for additional settings. Please check https://github.com/yamadashy/repomix for more information.
âœ– Error during packing


Need help?
â€¢ File an issue on GitHub: https://github.com/yamadashy/repomix/issues
â€¢ Join our Discord community: https://discord.gg/wNYzTwZFku
</file>

<file path="tests/__init__.py">
# This file makes the tests directory a Python package
</file>

<file path="tests/test_route_safety.py">
@pytest.fixture
def sample_crash_data()
â‹®----
"""Create sample crash data for testing"""
â‹®----
30.2672, 30.2772, 30.2872, 30.2972, 30.3072,  # Different lat bins
â‹®----
-97.7431, -97.7531, -97.7631, -97.7731, -97.7831,  # Different lng bins
â‹®----
@pytest.fixture
def sample_route()
â‹®----
"""Create a sample route for testing"""
â‹®----
def test_load_crash_data(sample_crash_data, tmp_path)
â‹®----
"""Test loading crash data"""
# Save sample data to temporary file
file_path = tmp_path / "test_data.csv"
â‹®----
# Test loading
loaded_data = load_crash_data(str(file_path))
â‹®----
def test_load_crash_data_invalid_file(tmp_path)
â‹®----
"""Test loading crash data with invalid file"""
â‹®----
def test_identify_crash_hotspots(sample_crash_data)
â‹®----
"""Test hotspot identification"""
hotspots = identify_crash_hotspots(sample_crash_data)
â‹®----
def test_train_model(sample_crash_data)
â‹®----
"""Test model training"""
â‹®----
model = train_model(hotspots)
â‹®----
# Test prediction
test_input = np.array([[30.2672, -97.7431]])
prediction = model.predict(test_input)
â‹®----
def test_calculate_safety_score(sample_route)
â‹®----
"""Test safety score calculation"""
â‹®----
def test_get_google_routes()
â‹®----
"""Test Google Maps API route fetching"""
â‹®----
routes = get_google_routes("test_key", "Austin, TX", "Houston, TX")
â‹®----
def test_get_google_routes_error()
â‹®----
"""Test Google Maps API error handling"""
</file>

<file path="topic_prompts/initial_prompt.txt">
You are SmartDrive AI Assistant, an informative and helpful chatbot that assists users in understanding how their route is evaluated for safety and how the SmartDrive AI system works.

SmartDrive is an AI-powered route safety tool developed using crash data from Austin, Texas. It uses clustering algorithms (DBSCAN) to detect accident hotspots and assigns a Crash Severity Index to different zones based on crash frequency and severity. A machine learning model (Random Forest Regressor) then predicts the potential risk level for a given route.

Your job is to:
Help users understand how SmartDrive determines whether a route is high-risk or low-risk.
Explain how the clustering and crash severity model works in simple terms if asked.
Answer user questions about how the AI was trained, what kind of data was used, and what makes a zone high-risk.
Provide basic safety suggestions based on the userâ€™s route (if provided).
Remain clear, concise, and friendly in your explanations.
If unsure about something, explain the limitation and suggest where the user could learn more.

Example questions users may ask:
â€œWhy is this route considered high-risk?â€
â€œHow does your AI figure out which areas are dangerous?â€
â€œCan you explain how your crash data works?â€
â€œWhat makes SmartDrive better than Google Maps?â€

Always respond with helpful and respectful language, even if the question is unclear. Your goal is to educate and assist users while demonstrating the value of the SmartDrive AI system.
</file>

<file path="topic_prompts/voice_route_demo_prompt.txt">
# topic_prompts/voice_route_demo_prompt.txt

### System Message
You are SmartDrive Voice Assistant, a voiceâ€‘first GPSâ€‘driven safety companion. For each incoming position update:
- Load crash hotspots fromÂ output_files/high_crash_zones.geojson and apply a 50Â m buffer.
- If the coordinate is inside or within 50Â m of a hotspot, respond with a concise warning:
  â€œAlert: Highâ€‘crash zone ahead. Proceed with caution.â€
- Otherwise, respond with a brief navigation update, e.g.:
  â€œProceed straight for 200Â meters.â€
- Keep each response under 20 words, plain language, TTSâ€‘friendly.
- Use deterministic settings (temperature=0, top_p=0.1).
- Output **only** the spoken text (no JSON or markup).

### User Message
Coordinate update:
  latitude: {latitude}
  longitude: {longitude}
Previous coordinate:
  latitude: {prev_latitude}
  longitude: {prev_longitude}
</file>

<file path="tests/test_routes.py">
@pytest.fixture
def client()
â‹®----
def test_home_route(client)
â‹®----
"""Test the home route returns a successful response"""
response = client.get('/')
â‹®----
def test_test_openai_route(client)
â‹®----
"""Test the OpenAI test route returns a successful response"""
â‹®----
response = client.get('/test_openai')
# Accept both 200 and 500 status codes since API key might be missing in CI
â‹®----
data = json.loads(response.data)
â‹®----
def test_analyze_route_missing_params(client)
â‹®----
"""Test analyze_route with missing parameters"""
response = client.post('/analyze_route', json={})
â‹®----
def test_analyze_route_success(client)
â‹®----
"""Test successful route analysis"""
â‹®----
response = client.post('/analyze_route', json={
# Accept both 200 and 404 status codes since API key might be missing in CI
â‹®----
def test_chat_route(client)
â‹®----
"""Test the chat route"""
â‹®----
response = client.post('/chat', json={'message': 'Hello'})
â‹®----
def test_chat_route_missing_message(client)
â‹®----
"""Test chat route with missing message"""
response = client.post('/chat', json={})
â‹®----
def test_clear_session(client)
â‹®----
"""Test the clear_session route"""
response = client.get('/clear_session')
</file>

<file path=".gitignore">
# Environment variables
.env
.env.*
!.env.example
*.env
.env.local
.env.development
.env.test
.env.production

# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
*.egg-info/
.installed.cfg
*.egg

# Virtual Environment
venv/
ENV/

# IDE
.idea/
.vscode/
*.swp
*.swo

# OS
.DS_Store
.DS_Store?
._*
.Spotlight-V100
.Trashes
ehthumbs.db
Thumbs.db

# Flask Session
flask_session/
</file>

<file path="requirements-test.txt">
pytest==7.4.0
pytest-cov==4.1.0
requests==2.32.2
pytest-mock==3.12.0
python-dotenv==1.0.0
</file>

<file path="requirements.txt">
flask>=3.0.0
flask-session>=0.6.0
openai>=1.0.0
openai-whisper>=1.0.0  # Added for voice transcription support
pandas>=2.0.0
numpy>=1.24.0
scikit-learn>=1.3.0
geopy>=2.3.0
shapely>=2.0.0
requests>=2.31.0
python-dotenv>=1.0.0
joblib>=1.3.0
Werkzeug>=3.0.0
</file>

<file path=".github/workflows/python-test.yml">
name: Python Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9]

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Fetch all history for all branches and tags
    
    - name: Show commit being tested
      run: |
        echo "Testing commit: ${{ github.sha }}"
        git log -1 --pretty=format:"%h %s"
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: Run tests with coverage
      run: |
        pytest --cov=app --cov=Route_Safety --cov-report=xml tests/
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
        FLASK_SECRET_KEY: ${{ secrets.FLASK_SECRET_KEY }}
    
    - name: Upload coverage to Codecov
      if: env.CODECOV_TOKEN != ''
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
</file>

<file path="testing.ipynb">
{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Mean Squared Error on test data: 0.32457581361893867\n",
      "Found 3 route options.\n",
      "Route 1: Safety Score 6.68/10\n",
      "Route Summary:\n",
      "  - Head <b>east</b> on <b>E 5th St.</b> toward <b>Brazos St</b> (0.5 mi, 3 mins)\n",
      "  - Turn <b>right</b> onto <b>S I-35 Frontage Rd</b> (177 ft, 1 min)\n",
      "  - Slight <b>left</b> toward <b>N Interstate 35 Frontage Rd</b> (381 ft, 1 min)\n",
      "...\n",
      "Route 2: Safety Score 6.52/10\n",
      "Route Summary:\n",
      "  - Head <b>east</b> on <b>E 5th St.</b> toward <b>Brazos St</b> (0.5 mi, 3 mins)\n",
      "  - Turn <b>right</b> onto <b>S I-35 Frontage Rd</b> (177 ft, 1 min)\n",
      "  - Slight <b>left</b> toward <b>N Interstate 35 Frontage Rd</b> (381 ft, 1 min)\n",
      "...\n",
      "Route 3: Safety Score 6.86/10\n",
      "Route Summary:\n",
      "  - Head <b>east</b> on <b>E 5th St.</b> toward <b>Brazos St</b> (410 ft, 1 min)\n",
      "  - Turn <b>right</b> onto <b>Brazos St</b> (358 ft, 1 min)\n",
      "  - Turn <b>right</b> onto <b>E 4th St</b> (436 ft, 1 min)\n",
      "...\n",
      "Safest Route: 3 with Safety Score: 6.86/10\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n",
      "/Users/khushl/Documents/GitHub/Smart-Drive/venv/lib/python3.11/site-packages/sklearn/utils/validation.py:2739: UserWarning: X does not have valid feature names, but RandomForestRegressor was fitted with feature names\n",
      "  warnings.warn(\n"
     ]
    }
   ],
   "source": [
    "import pandas as pd\n",
    "import numpy as np\n",
    "import json\n",
    "import requests\n",
    "from sklearn.model_selection import train_test_split\n",
    "from sklearn.ensemble import RandomForestRegressor\n",
    "from sklearn.metrics import mean_squared_error\n",
    "from geopy.distance import geodesic\n",
    "from shapely.geometry import Point, Polygon\n",
    "from sklearn.preprocessing import StandardScaler\n",
    "import os\n",
    "\n",
    "# 1. Processing Crash Data and Training the AI Model\n",
    "\n",
    "def load_crash_data(filename):\n",
    "    data = pd.read_csv(filename, low_memory=False)\n",
    "    data = data[['latitude', 'longitude', 'crash_sev_id', 'Crash timestamp (US/Central)']].dropna()\n",
    "    return data\n",
    "\n",
    "\n",
    "def identify_crash_hotspots(data, grid_size=0.01):\n",
    "    data['lat_bin'] = (data['latitude'] // grid_size) * grid_size\n",
    "    data['lng_bin'] = (data['longitude'] // grid_size) * grid_size\n",
    "\n",
    "    hotspot_severity = data.groupby(['lat_bin', 'lng_bin'])['crash_sev_id'].mean().reset_index()\n",
    "    return hotspot_severity\n",
    "\n",
    "\n",
    "def train_model(hotspot_data):\n",
    "    X = hotspot_data[['lat_bin', 'lng_bin']]\n",
    "    y = hotspot_data['crash_sev_id']\n",
    "\n",
    "    X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)\n",
    "\n",
    "    model = RandomForestRegressor(n_estimators=100, random_state=42)\n",
    "    model.fit(X_train, y_train)\n",
    "\n",
    "    y_pred = model.predict(X_test)\n",
    "    mse = mean_squared_error(y_test, y_pred)\n",
    "    print(f'Mean Squared Error on test data: {mse}')\n",
    "\n",
    "    return model\n",
    "\n",
    "\n",
    "# 2. Fetching Routes and Evaluating with AI Model\n",
    "\n",
    "def get_google_routes(api_key):\n",
    "    base_url = \"https://maps.googleapis.com/maps/api/directions/json\"\n",
    "    params = {\n",
    "        \"origin\": \"Austin, TX\",\n",
    "        \"destination\": \"Houston, TX\",\n",
    "        \"mode\": \"driving\",\n",
    "        \"alternatives\": \"true\",\n",
    "        \"key\": api_key\n",
    "    }\n",
    "\n",
    "    response = requests.get(base_url, params=params)\n",
    "\n",
    "    if response.status_code == 200:\n",
    "        routes = response.json().get(\"routes\", [])\n",
    "        print(f\"Found {len(routes)} route options.\")\n",
    "        return routes\n",
    "    else:\n",
    "        print(f\"Error: {response.status_code} - {response.text}\")\n",
    "        return []\n",
    "\n",
    "\n",
    "def calculate_safety_score(route, model):\n",
    "    scores = []\n",
    "    total_duration = 0\n",
    "\n",
    "    for leg in route['legs']:\n",
    "        total_duration += leg['duration']['value'] / 60  # Convert to minutes\n",
    "        for step in leg['steps']:\n",
    "            lat = step['end_location']['lat']\n",
    "            lng = step['end_location']['lng']\n",
    "            safety_score = model.predict(np.array([[lat, lng]]))[0]\n",
    "            scores.append(safety_score)\n",
    "\n",
    "    avg_score = np.mean(scores) if scores else 0\n",
    "    return min(max(10 - avg_score, 1), 10), total_duration\n",
    "\n",
    "\n",
    "# Putting it all together\n",
    "\n",
    "def main():\n",
    "    api_key = input(\"Enter your Google Maps API key: \")\n",
    "    crash_data_file = 'data.csv'\n",
    "\n",
    "    data = load_crash_data(crash_data_file)\n",
    "    hotspot_data = identify_crash_hotspots(data)\n",
    "    model = train_model(hotspot_data)\n",
    "\n",
    "    routes = get_google_routes(api_key)\n",
    "    \n",
    "    safety_scores_and_times = [calculate_safety_score(route, model) for route in routes]\n",
    "    \n",
    "    for i, (route, (score, duration)) in enumerate(zip(routes, safety_scores_and_times)):\n",
    "        print(f\"Route {i + 1}: Safety Score {score:.2f}/10, Estimated Time: {duration:.2f} mins\")\n",
    "        print(\"Route Summary:\")\n",
    "        for leg in route['legs']:\n",
    "            for step in leg['steps'][:3]:  # Show first few steps for brevity\n",
    "                print(f\"  - {step['html_instructions']} ({step['distance']['text']}, {step['duration']['text']})\")\n",
    "            print(\"...\")\n",
    "\n",
    "    safest_route_idx = np.argmax([score for score, _ in safety_scores_and_times])\n",
    "    print(f\"Safest Route: {safest_route_idx + 1} with Safety Score: {safety_scores_and_times[safest_route_idx][0]:.2f}/10, Estimated Time: {safety_scores_and_times[safest_route_idx][1]:.2f} mins\")\n",
    "\n",
    "\n",
    "if __name__ == \"__main__\":\n",
    "    main()\n",
    "\n"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "venv",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.11"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 2
}
</file>

<file path="static/index.css">
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ General page layout and background â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
body {
â‹®----
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Main container styling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#container {
â‹®----
h1 {
â‹®----
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Input fields â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#input-fields {
â‹®----
#input-fields label { font-weight: bold; color: #555; }
â‹®----
#input-fields input {
â‹®----
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Map container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#map-container {
â‹®----
#map { height: 100%; width: 100%; }
â‹®----
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Chat container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#chat-container {
â‹®----
.message {
â‹®----
.user-message  { background-color:#007bff; color:#fff; float:right; border-bottom-right-radius:4px; margin-left:20%; }
.bot-message   { background-color:#e9ecef; color:#333; float:left;  border-bottom-left-radius:4px; margin-right:20%; }
â‹®----
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Input & buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#input-container { display:flex; gap:10px; }
â‹®----
#user-input {
â‹®----
button {
button:hover { background-color:#0056b3; }
â‹®----
.loading { opacity:0.5; pointer-events:none; }
â‹®----
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
â‹®----
#container { width:95%; margin:10px; padding:15px; }
#map-container { height:300px; }
.message { max-width:90%; }
â‹®----
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/*                      â˜…  Routeâ€‘picker styling â˜…                      */
â‹®----
/* Container that holds all route cards (injected after results arrive) */
#route-picker{
â‹®----
/* Each selectable card */
.route-card{
â‹®----
/* Hide the browserâ€™s default radio dot */
.route-card input[type="radio"]{
â‹®----
/* Hover state */
.route-card:hover{ border-color:#007bff; box-shadow:0 2px 6px rgba(0,123,255,0.25); }
â‹®----
/* Selected (checked) state */
.route-card input[type="radio"]:checked + .route-info,
â‹®----
/* Inner div where JS will inject miniâ€‘stats */
.route-info{
â‹®----
pointer-events:none; /* allow click to propagate to hidden radio */
</file>

<file path="Route_Safety.py">
# Force reload environment variables
â‹®----
# 1. Processing Crash Data and Training the AI Model
â‹®----
def load_crash_data(filename)
â‹®----
data = pd.read_csv(filename, low_memory=False)
data = data[['latitude', 'longitude', 'crash_sev_id', 'Crash timestamp (US/Central)']].dropna()
â‹®----
def identify_crash_hotspots(data, grid_size=0.01)
â‹®----
hotspot_severity = data.groupby(['lat_bin', 'lng_bin'])['crash_sev_id'].mean().reset_index()
â‹®----
def train_model(hotspot_data)
â‹®----
X = hotspot_data[['lat_bin', 'lng_bin']]
y = hotspot_data['crash_sev_id']
â‹®----
model = RandomForestRegressor(n_estimators=100, random_state=42)
â‹®----
y_pred = model.predict(X_test)
mse = mean_squared_error(y_test, y_pred)
â‹®----
model_file_path = 'trainedModel.joblib'
â‹®----
# 2. Fetching Routes and Evaluating with AI Model
â‹®----
def get_google_routes(api_key, origin, destination)
â‹®----
"""
    Fetch driving routes (including alternatives) from Google Directions API
    and log both HTTP and API-level status messages for debugging.
    """
base_url = "https://maps.googleapis.com/maps/api/directions/json"
params = {
response = requests.get(base_url, params=params)
â‹®----
data = response.json()
â‹®----
api_status = data.get("status")
error_message = data.get("error_message")
â‹®----
routes = data.get("routes", [])
â‹®----
def calculate_safety_score(route, model)
â‹®----
scores = []
total_duration = 0
â‹®----
total_duration += leg['duration']['value'] / 60  # minutes
â‹®----
lat = step['end_location']['lat']
lng = step['end_location']['lng']
df = pd.DataFrame([[lat, lng]], columns=['lat_bin', 'lng_bin'])
safety_score = model.predict(df)[0]
â‹®----
avg_score = np.mean(scores) if scores else 0
â‹®----
# --- New hotspot and LLMâ€‘enhanced instructions ---
â‹®----
def load_hotspot_polygons(geojson_path="output_files/high_crash_zones.geojson")
â‹®----
"""
    Load crash-hotspot polygons from a GeoJSON file.
    """
polygons = []
â‹®----
gj = json.load(f)
â‹®----
coords = feat["geometry"]["coordinates"][0]
poly = Polygon([(lng, lat) for lat, lng in coords])
â‹®----
# Pre-load hotspot polygons once
_HOTSPOT_POLYGONS = load_hotspot_polygons()
â‹®----
def is_in_hotspot(lat, lng, buffer_m=50)
â‹®----
"""
    Check if a coordinate lies within or near (buffer_m) any crash-hotspot polygon.
    """
buffer_deg = buffer_m / 111320.0  # approximate meters to degrees
point = Point(lng, lat)
â‹®----
def generate_enhanced_instruction(html_instruction, lat, lng, model_name="gpt-3.5-turbo")
â‹®----
"""
    Given a Google html_instructions string and a coordinate, produce
    a concise, TTSâ€‘friendly navigation cue (with crash warning if needed).
    """
â‹®----
# Crashâ€‘zone override
â‹®----
# Otherwise, ask the LLM to rephrase
prompt = (
resp = openai.chat.completions.create(
â‹®----
# --- Existing voiceâ€‘first function (if needed) ---
â‹®----
def generate_voice_update(lat, lng, prev_lat, prev_lng, model_name="gpt-3.5-turbo")
â‹®----
"""
    Legacy voiceâ€‘first update generator using our demo prompt.
    """
â‹®----
prompt_file = "topic_prompts/voice_route_demo_prompt.txt"
â‹®----
content = f.read()
â‹®----
system_content = system_part.replace("### System Message", "").strip()
user_template = user_part.strip()
â‹®----
user_content = user_template.format(
messages = [
â‹®----
# --- Main CLI entrypoint ---
â‹®----
def main()
â‹®----
api_key = line.strip().split('=')[1]
â‹®----
api_key = os.getenv('GOOGLE_MAPS_API_KEY')
â‹®----
crash_data_file = 'data.csv'
data = load_crash_data(crash_data_file)
hotspot_data = identify_crash_hotspots(data)
model = train_model(hotspot_data)
â‹®----
routes = get_google_routes(api_key, "Austin, TX", "Houston, TX")
safety_scores_and_times = [calculate_safety_score(route, model) for route in routes]
â‹®----
safest_route_idx = np.argmax([score for score, _ in safety_scores_and_times])
</file>

<file path="README.md">
# Smart Drive

A route safety analysis tool that uses an ML model to evaluate the safety of different driving routes.


## Features

- Real-time route safety analysis using historical crash data
- Multiple route options with safety scores
- AI-powered chat assistant for route recommendations
- Interactive map interface
- Crash hotspot identification
- Estimated travel times and distances
- Route step-by-step instructions

## Setup

1. Clone the repository:
   ```bash
   git clone https://github.com/yourusername/Smart-Drive.git
   cd Smart-Drive
   ```

2. Create and activate a virtual environment:
   ```bash
   python -m venv venv
   source venv/bin/activate  # On Windows: venv\Scripts\activate
   ```

3. Install the required packages:
   ```bash
   pip install -r requirements.txt
   ```

4. Get your API keys:
   - **Google Maps API Key**:
     - Go to [Google Cloud Console](https://console.cloud.google.com/)
     - Create a new project or select an existing one
     - Enable the Directions API
     - Create an API key in Credentials
   
   - **OpenAI API Key**:
     - Go to [OpenAI Platform](https://platform.openai.com/)
     - Create an account or sign in
     - Generate an API key in your account settings

5. Set up your environment variables:
   - Copy `.env.example` to `.env`:
     ```bash
     cp .env.example .env
     ```
   - Open `.env` and add your API keys:
     ```
     GOOGLE_MAPS_API_KEY=your_google_maps_api_key
     OPENAI_API_KEY=your_openai_api_key

     ```

## Usage

1. Start the Flask application:
   ```bash
   python app.py
   ```

2. Open your web browser and navigate to:
   ```
   http://localhost:8080
   ```

3. Enter your starting and destination locations to get route analysis.

## Important Notes

- The application requires both Google Maps API and OpenAI API keys
- Google Maps API has a free tier with generous limits for personal use
- OpenAI API usage is billed based on token usage
- Never share your API keys or commit them to version control
- The `.env` file is already in `.gitignore` to prevent accidental commits

## Project Structure

```
Smart-Drive/
â”œâ”€â”€ app.py                 # Main Flask application
â”œâ”€â”€ Route_Safety.py        # Route analysis and safety scoring
â”œâ”€â”€ requirements.txt       # Python dependencies
â”œâ”€â”€ static/               # Static files (CSS, JS)
â”œâ”€â”€ templates/            # HTML templates
â”œâ”€â”€ topic_prompts/        # AI chat prompts
â”œâ”€â”€ trainedModel.joblib   # Trained safety model
â””â”€â”€ data.csv             # Historical crash data
```

## Contributing

1. Fork the repository
2. Create your feature branch (`git checkout -b feature/AmazingFeature`)
3. Commit your changes (`git commit -m 'Add some AmazingFeature'`)
4. Push to the branch (`git push origin feature/AmazingFeature`)
5. Open a Pull Request
<<<<<<< HEAD
=======


>>>>>>> 05e0e97f09a5de4a5431905e2e75b4864b7399e4
</file>

<file path="templates/index.html">
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Drive AI</title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='index.css') }}">

    <!-- GoogleÂ Maps loader -->
    <script>
        /* Stub â€” real init comes from static/script.js */
        window.initMap = () => console.log('Map init placeholder');

        function loadGoogleMapsAPI () {
            const s = document.createElement('script');
            s.src =
              `https://maps.googleapis.com/maps/api/js` +
              `?key={{ google_maps_api_key }}` +
              `&callback=initMap&libraries=places,directions,geometry`;
            s.async = true; s.defer = true;
            s.onerror = () => console.error('Failed to load GoogleÂ Maps API');
            document.head.appendChild(s);
        }
        document.addEventListener('DOMContentLoaded', loadGoogleMapsAPI);
    </script>
</head>
<body>
    <div id="container">
        <h1>AIÂ SmartÂ Drive</h1>

        <!-- â”€â”€ Input fields â”€â”€ -->
        <div id="input-fields">
            <label for="start-location">CurrentÂ Location:</label>
            <input id="start-location" placeholder="Enter your current location">

            <label for="end-location">Destination:</label>
            <input id="end-location" placeholder="Enter your destination">

            <button id="start-button" onclick="findSafeRoute()">FindÂ SafeÂ Route</button>
            <!-- Simulateâ€‘Drive button is injected by script.js -->
        </div>

        <!-- â”€â”€ Map â”€â”€ -->
        <div id="map-container">
            <div id="map">
                <div id="map-loading" style="display:none;">LoadingÂ mapâ€¦</div>
            </div>
        </div>

        <!-- ğŸ”¹ Routeâ€‘picker placeholder (populated by script.js) -->
        <div id="route-picker"></div>

        <!-- â”€â”€ Chat â”€â”€ -->
        <div id="chat-container"></div>
        <div id="input-container">
            <input id="user-input" placeholder="Ask about a routeâ€¦">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <!-- Main JS -->
    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>
</file>

<file path="static/script.js">
/**
 * Handles map initialization, route finding, chat, and turnâ€‘byâ€‘turn simulation
 */
â‹®----
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Global state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
â‹®----
/* Simulation globals */
â‹®----
let waypoints        = [];   // google.maps.LatLng for each step end
let voicePackets     = [];   // { text, latitude, longitude }
â‹®----
/* Route context */
â‹®----
let currentRouteIndex = 0;   // 0Â = first route; updated to safest index
let currentRouteObj   = null;/* remembers the chosen route JSON */
let drawnPolyline     = null;/* main route polyline on the map */
let currentRoutes     = [];  /* all routes returned from the server */
â‹®----
/* helper to grab/insert the picker container */
const routePickerRoot = () =>
document.getElementById('route-picker') ??
â‹®----
const el = document.createElement('div');
â‹®----
document.getElementById('input-fields').appendChild(el);
â‹®----
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Map init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
â‹®----
map = new google.maps.Map(document.getElementById('map'), {
â‹®----
directionsService  = new google.maps.DirectionsService();
directionsRenderer = new google.maps.DirectionsRenderer({
â‹®----
suppressMarkers: true,   // we drop our own car marker
preserveViewport: true   // donâ€™t autoâ€‘zoom; weâ€™ll fit bounds ourselves
â‹®----
/* Simulateâ€‘Drive button (injected so HTML stays clean) */
simulateBtn             = document.createElement('button');
â‹®----
document.getElementById('input-fields').appendChild(simulateBtn);
simulateBtn.addEventListener('click', simulateDrive);
â‹®----
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Route display & prep â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function displayRoute(route) {
if (!route?.legs?.length) { console.error('Invalid route data'); return; }
â‹®----
/* â‘  Clear any previously drawn polyline */
drawnPolyline?.setMap(null);
â‹®----
/* â‘¡ Draw the Google overview_polyline so the map always matches the serverâ€™s route */
â‹®----
google.maps.geometry.encoding.decodePath(route.overview_polyline.points);
drawnPolyline = new google.maps.Polyline({
â‹®----
/* â‘¢ Fit viewport neatly around that path */
const bounds = new google.maps.LatLngBounds();
fullPath.forEach(p => bounds.extend(p));
map.fitBounds(bounds);
â‹®----
/* â‘£ Store & continue with simulation prep */
â‹®----
prepareSimulationFromSteps(route);
â‹®----
function prepareSimulationFromSteps(route) {
â‹®----
/* Build waypoint list */
waypoints = steps.map(s =>
new google.maps.LatLng(s.end_location.lat, s.end_location.lng)
â‹®----
/* Google fallback packets (raw html stripped) */
voicePackets = steps.map(s => ({
text: s.html_instructions.replace(/<[^>]+>/g, '').replace(/&nbsp;/g, ' ').trim(),
â‹®----
/* Async: fetch enriched packets (LLM + hotspot) */
fetchEnhancedPackets()
.then(pkts => { if (pkts.length) voicePackets = pkts; })
.catch(err  => console.warn('Enhanced stream failed; using fallback', err));
â‹®----
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SSE fetch helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function fetchEnhancedPackets() {
const resp = await fetch('/stream_route', {
â‹®----
body   : JSON.stringify({
â‹®----
if (!resp.ok) throw new Error(`HTTPÂ ${resp.status}`);
â‹®----
const reader  = resp.body.getReader();
const decode  = new TextDecoder();
â‹®----
const { value, done } = await reader.read();
â‹®----
buffer += decode.decode(value, { stream: true });
const chunks = buffer.split('\n\n');
buffer = chunks.pop();
chunks.forEach(chunk => {
if (chunk.startsWith('data: ')) {
try { packets.push(JSON.parse(chunk.slice(6))); } catch {}
â‹®----
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Simulation (3Â s per step) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function simulateDrive() {
clearInterval(simulationInterval);
[marker, traveledPath, upcomingPath].forEach(obj => obj?.setMap?.(null));
â‹®----
/* â‘ Â Create invisible polylines (map omitted) so we can still manage getPath() */
upcomingPath = new google.maps.Polyline({
â‹®----
traveledPath = new google.maps.Polyline({
â‹®----
/* â‘¡Â Car marker */
marker = new google.maps.Marker({
â‹®----
scaledSize: new google.maps.Size(12, 12)
â‹®----
map.panTo(waypoints[0]);
â‹®----
/* â‘¢Â Animate through waypoints */
â‹®----
simulationInterval = setInterval(() => {
â‹®----
handleVoicePacket({
â‹®----
latitude : waypoints.at(-1).lat(),
longitude: waypoints.at(-1).lng()
â‹®----
marker.setPosition(pos);
traveledPath.getPath().push(pos);       // â† invisible polyline keeps internal path list
upcomingPath.getPath().removeAt(0);
map.panTo(pos);
â‹®----
handleVoicePacket(pkt);
â‹®----
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Routeâ€‘picker UI (radio cards) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderRoutePicker(details) {
const root = routePickerRoot();
â‹®----
details.forEach((d, i) => {
const card = document.createElement('label');
â‹®----
TimeÂ ${d.duration.toFixed(0)}Â min<br>
â‹®----
card.querySelector('input').addEventListener('change', () => {
â‹®----
displayRoute(currentRoutes[currentRouteIndex]);
â‹®----
root.appendChild(card);
â‹®----
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Server call: safest route & details â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function findSafeRoute() {
const start = document.getElementById('start-location').value.trim();
const end   = document.getElementById('end-location').value.trim();
if (!start || !end) return alert('Please enter both locations');
â‹®----
document.getElementById('map-container').style.opacity = 0.5;
fetch('/analyze_route', {
â‹®----
body   : JSON.stringify({ start, end })
â‹®----
.then(r => r.ok ? r.json() : r.json().then(e => { throw e; }))
.then(data => {
â‹®----
/* Determine safest route */
currentRouteIndex = data.route_details.reduce(
â‹®----
displayRouteDetails(data.route_details);
renderRoutePicker(data.route_details);
â‹®----
.catch(err => { console.error(err); alert(err.error || err); })
.finally(() => {
document.getElementById('map-container').style.opacity = 1;
â‹®----
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Chat helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function displayRouteDetails(details) {
const chat = document.getElementById('chat-container');
â‹®----
`SafetyÂ ${d.safety_score}/10 â€¢ TimeÂ ${d.duration.toFixed(0)}Â min â€¢ DistÂ ${d.distance}\n` +
`First steps:\n${d.steps.join('\n')}`;
addMessageToChat(msg, 'bot');
â‹®----
function sendMessage() {
const input = document.getElementById('user-input');
const txt   = input.value.trim();
â‹®----
const btn = document.querySelector('#input-container button');
â‹®----
addMessageToChat(txt, 'user'); input.value = '';
â‹®----
fetch('/chat', {
â‹®----
body   : JSON.stringify({ message: txt })
â‹®----
.then(d => addMessageToChat(d.response ?? `Error: ${d.error}`, 'bot'))
.catch(e => addMessageToChat(`Error: ${e.error || e}`, 'bot'))
â‹®----
input.focus();
â‹®----
function addMessageToChat(msg, who) {
const c  = document.getElementById('chat-container');
â‹®----
el.classList.add('message', `${who}-message`);
el.innerHTML = msg.replace(/\n/g, '<br>');
c.appendChild(el);
el.scrollIntoView({ behavior: 'smooth', block: 'end' });
â‹®----
function handleVoicePacket(pkt) {
addMessageToChat(pkt.text, 'bot');
speechSynthesis.speak(new SpeechSynthesisUtterance(pkt.text));
â‹®----
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ DOM wiring â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.addEventListener('DOMContentLoaded', () => {
document.getElementById('start-button').addEventListener('click', findSafeRoute);
document.getElementById('user-input').addEventListener('keypress', e => {
if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
â‹®----
document.querySelector('#input-container button').addEventListener('click', sendMessage);
â‹®----
addMessageToChat(
</file>

<file path="app.py">
# --------------------------------------------------
# basic setup
â‹®----
logger = logging.getLogger(__name__)
â‹®----
load_dotenv()  # .env
â‹®----
google_maps_api_key   = os.getenv("GOOGLE_MAPS_API_KEY")
VOICE_MODEL           = os.getenv("VOICE_MODEL", "gpt-3.5-turbo")
â‹®----
app = Flask(__name__)
â‹®----
# ML safety model (warmâ€‘up at startup)
â‹®----
_safety_model = train_model(
â‹®----
# routes
â‹®----
@app.route("/")
def home()
â‹®----
# ---------- 1. analyse multiple routes ----------
â‹®----
@app.route("/analyze_route", methods=["POST"])
def analyze_route()
â‹®----
data  = request.json or {}
start = data.get("start")
end   = data.get("end")
â‹®----
routes = get_google_routes(google_maps_api_key, start, end)
â‹®----
details = []
â‹®----
# index of safest route (highest score)
safest_idx = int(np.argmax([d["safety_score"] for d in details]))
â‹®----
except Exception as exc:  # noqa
â‹®----
# ---------- 2. stream a chosen route (or gps sequence) ----------
â‹®----
@app.route("/stream_route", methods=["POST"])
def stream_route()
â‹®----
"""
    Two modes:

    â€¢Â `gps_sequence`  â€“ list of {latitude, longitude}
       â†’ generate_voice_update (continuousâ€‘drive)

    â€¢Â `start`, `end`  (+ optional `route_index`, defaultÂ 0)
       â†’ pull Google Directions steps for that route
         and call generate_enhanced_instruction for each turn.
    """
data = request.json or {}
â‹®----
# --------------------------------------------------
#  modeÂ A â€“ preâ€‘defined GPS track
â‹®----
seq           = data["gps_sequence"]
enhanced_turn = False
â‹®----
#  modeÂ B â€“ Google route steps
â‹®----
route_idx = int(data.get("route_index", 0))
routes    = get_google_routes(google_maps_api_key, start, end)
â‹®----
chosen   = routes[route_idx]
steps    = chosen["legs"][0]["steps"]
seq      = [
enhanced_turn = True
â‹®----
#  SSE generator
â‹®----
def event_stream()
â‹®----
prev = seq[0]
â‹®----
text = generate_enhanced_instruction(
â‹®----
text = generate_voice_update(
â‹®----
prev = pt
â‹®----
# arrival
arr = dict(
â‹®----
# ---------- 3. tiny helper routes ----------
â‹®----
@app.route("/chat", methods=["POST"])
def chat()
â‹®----
user_msg = request.json.get("message")
â‹®----
convo = session.setdefault("conversation", [])
â‹®----
system_prompt = f.read()
â‹®----
msgs = [{"role": "system", "content": system_prompt}] + convo[-10:] + [
resp = openai.chat.completions.create(
bot = resp.choices[0].message.content
â‹®----
@app.route("/clear_session")
def clear_session()
â‹®----
# ----------  entrypoint ----------
</file>

</files>
